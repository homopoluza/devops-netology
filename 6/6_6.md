# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
```
 db.currentOp() определяет ID операции
 db.killOp(opid) прекращает необходимую операцию
```
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

## Ответ:

Использовать db.collection.explain() для анализа плана запроса. Использовать индексы.


## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

## Ответ:

Latency generated by expires

Вероятно, количество истекших ключей в одно и тоже время превысело 25% от общего количества, и Redis заблокировал операции записи, пока значение истекших ключей не понизится до 25%. 

 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

## Ответ:
Usually it indicates network connectivity trouble and you should check the condition of your network if this error occurs frequently. If the error message includes “during query,” this is probably the case you are experiencing.

Проблемы с сетью, стоит увеличить net_read_timeout со стандартных 30 секунд до 60 или больше.

If the cause is none of those just described, you may be experiencing a problem with BLOB values that are larger than max_allowed_packet, which can cause this error with some clients. Sometime you may see an ER_NET_PACKET_TOO_LARGE error, and that confirms that you need to increase max_allowed_packet.

Если проблема связана с BLOB данными, то следует увеличить max_allowed_packet параметр.


## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

## Ответ:

Нехватка оперативной памяти. Необходимо выделить больше ресурсов.  
Следует выставить ограничение, чтобы PostgreSQL не потреблял все ресурсы хоста.   
Настроить oomprotect, чтобы oom-killer убивал другой менее важный процесс.  
```
rcctl set PostgreSQL oomprotect -1000
```
